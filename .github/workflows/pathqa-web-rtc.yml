name: pathqa-web-rtc

on:
  workflow_dispatch:
  push:
    branches: [pathqa_development_master_deployment]
    paths:
      - 'web-rtc/**'
env:
  DOCKER_IMAGE_NAME: web-rtc
  REMOTE_HOST: ${{ secrets.PATHQA_HOST }}
  REMOTE_USER: ${{ secrets.DEV_USER }}
  REMOTE_PORT: 22
  ENV_FILE_PATH: /home/ubuntu/deploy/web-rtc/.env
  PEM_FOLDER_PATH: /home/ubuntu/deploy/web-rtc/.pem
  TARGET_PLATFORM: ${{ secrets.TARGET_PLATFORM_A }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image for target platform
        run: |
          cd web-rtc
          echo "Building for platform: $TARGET_PLATFORM"
          docker buildx build \
            --platform $TARGET_PLATFORM \
            --output type=tar,dest=../app-image.tar \
            --progress=plain \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            -t $DOCKER_IMAGE_NAME:${{ github.sha }} \
            -t $DOCKER_IMAGE_NAME:latest \
            .

      - name: Deploy to remote host
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DEV_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          scp -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -P $REMOTE_PORT \
              app-image.tar \
              $REMOTE_USER@$REMOTE_HOST:/tmp/

          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -P $REMOTE_PORT \
              $REMOTE_USER@$REMOTE_HOST << 'EOF'
          DOCKER_IMAGE_NAME="${{ env.DOCKER_IMAGE_NAME }}"
          ENV_FILE_PATH="${{ env.ENV_FILE_PATH }}"
          PEM_FOLDER_PATH="${{ env.PEM_FOLDER_PATH }}"

          docker load -i /tmp/app-image.tar
          rm /tmp/app-image.tar

          docker stop $DOCKER_IMAGE_NAME 2>/dev/null || true
          docker rm $DOCKER_IMAGE_NAME 2>/dev/null || true

          if [ ! -f "$ENV_FILE_PATH" ]; then
            echo "Error: .env file not found at $ENV_FILE_PATH"
            exit 1
          fi
          if [ ! -d "$PEM_FOLDER_PATH" ]; then
            echo "Error: .pem folder not found at $PEM_FOLDER_PATH"
            exit 1
          fi

          docker run -d \
            --name $DOCKER_IMAGE_NAME \
            --restart unless-stopped \
            -p 3000:3000 \
            --env-file $ENV_FILE_PATH \
            -v $PEM_FOLDER_PATH:/app/.pem \
            --mount type=bind,src=/etc/letsencrypt,dst=/etc/letsencrypt,ro \
            $DOCKER_IMAGE_NAME:${{ github.sha }}

          docker image prune -f
          echo "web-rtc deployment completed successfully"
          EOF

      - name: Verify deployment
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DEV_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -p $REMOTE_PORT \
              $REMOTE_USER@$REMOTE_HOST \
              "docker ps | grep ${{ env.DOCKER_IMAGE_NAME }} && echo 'web-rtc deployment successful!'"
