- name: Deploy to remote host
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DEV_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -P $REMOTE_PORT \
              app-image.tar $REMOTE_USER@$REMOTE_HOST:/tmp/
          
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p $REMOTE_PORT \
              $REMOTE_USER@$REMOTE_HOST <<'EOF'
            set -e
            docker load -i /tmp/app-image.tar
            rm /tmp/app-image.tar
            
            docker stop ${{ env.DOCKER_IMAGE_NAME }} || true
            docker rm ${{ env.DOCKER_IMAGE_NAME }} || true
            
            docker run -d \
                --name ${{ env.DOCKER_IMAGE_NAME }} \
                --restart unless-stopped \
                -p 3004:3004 \
                --env-file ${{ env.ENV_FILE_PATH }} \
                -v ${{ env.PEM_FOLDER_PATH }}:/app/.pem \
                --mount type=bind,src=/etc/letsencrypt,dst=/etc/letsencrypt,ro \
                ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
            
            docker image prune -f
            echo "Portal deployment completed successfully"
          EOF
